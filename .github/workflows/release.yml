name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

# 1. Install System Dependencies
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfontconfig1-dev libxcb-shape0-dev libxcb-xfixes0-dev libxkbcommon-dev

      # Run Tests ---
      - name: Run Unit Tests
        run: cargo test --verbose
      # ----------------------

      # 2. Install Packaging Tools
      - name: Install cargo-deb
        run: cargo install cargo-deb

      # 3. Build Release Binaries (Standard)
      - name: Build Release
        run: cargo build --release --features gui

      # 4. Build Debian Package (.deb)
      # This uses the [package.metadata.deb] section in your Cargo.toml
      - name: Build Deb
        run: cargo deb --no-build --features gui 
        # --no-build uses the binaries we just built in step 3 to save time

      # 5. Package Generic Linux Tarball (for non-Debian distros)
      - name: Create Archive
        run: |
          STAGING="cfait-${{ github.ref_name }}"
          mkdir -p "$STAGING"

          # Copy Binaries (Renaming gui -> cfait-gui)
          cp target/release/cfait "$STAGING/"
          cp target/release/gui "$STAGING/cfait-gui"
          
          # Assets
          cp README.md LICENSE "$STAGING/"
          cp assets/cfait.desktop "$STAGING/"
          cp assets/cfait.svg "$STAGING/"

          # Compress
          tar -czvf "cfait-linux-${{ github.ref_name }}.tar.gz" "$STAGING"

      # 6. Publish to GitHub Releases
      - name: Upload Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            cfait-linux-${{ github.ref_name }}.tar.gz
            target/debian/*.deb

  package-arch:
    needs: build-linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Generate Production PKGBUILD
        run: |
          VERSION=${{ github.ref_name }}
          # Note: Assuming your gitlab tags match github tags
          SOURCE_URL="https://github.com/${{ github.repository }}/archive/${{ github.ref_name }}.tar.gz"
          wget -O source.tar.gz "$SOURCE_URL"
          
          HASH=$(sha256sum source.tar.gz | awk '{print $1}')
          echo "Calculated Hash: $HASH"
          
          sed -i "s/'SKIP'/'$HASH'/" packaging/arch/PKGBUILD
          cp packaging/arch/PKGBUILD PKGBUILD-release

      - name: Upload PKGBUILD to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: PKGBUILD-release