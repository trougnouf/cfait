name: Test and Rolling Release

on:
  push:
    branches:
      - "master"
      - "**"
    tags-ignore:
      - "**"
  pull_request:

jobs:
  # --- JOB 1: TESTS ---
  test:
    runs-on: self-hosted-arch
    container:
      image: local/arch-builder
      volumes:
        - cargo-registry:/usr/local/cargo/registry
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run unit tests
        run: cargo test --all-features --verbose

      - name: Run linter (clippy)
        run: cargo clippy --all-features -- -D warnings

  # --- JOB 2: BUILD AND ROLLING RELEASE ---
  rolling-android:
    needs: test
    # Only run this job on the master branch after tests pass
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    runs-on: self-hosted-ubuntu
    container:
      image: local/ubuntu-builder
      volumes:
        - cargo-registry:/usr/local/cargo/registry
        - gradle-cache:/root/.gradle
      env:
        RUSTFLAGS: "--remap-path-prefix ${{ github.workspace }}=/c --remap-path-prefix /usr/local/cargo=/cargo -C link-arg=-Wl,--build-id=none"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Restore Keystore
        run: echo "${{ secrets.ANDROID_SIGNING_KEYSTORE_B64 }}" | base64 --decode > cfait-rolling.keystore

      - name: Build Rust JNI Libs
        run: |
          cargo ndk \
            -t aarch64-linux-android \
            -t armv7-linux-androideabi \
            -t x86_64-linux-android \
            -o ./android/app/src/main/jniLibs \
            --platform 28 \
            build --release --lib --features mobile

      - name: Build Signed Android APK
        env:
          KEYSTORE_FILE: "${{ github.workspace }}/cfait-rolling.keystore"
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease --no-daemon

      - name: Upload APK as artifact
        uses: actions/upload-artifact@v3
        with:
          name: android-rolling-apk
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 1

      - name: Update Rolling Release on Codeberg
        env:
          TEA_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          # 1. Login
          tea login add --name codeberg --url ${{ github.server_url }} --token ${{ secrets.RELEASE_TOKEN }}

          REPO="${{ github.repository }}"
          TAG_NAME="rolling"

          # 2. Find the APK
          APK_PATH=$(find android/app/build/outputs/apk/release -name "*.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "âŒ APK not found"
            find android/app/build/outputs/apk -type f
            exit 1
          fi

          # 3. Update tag
          git tag -f "$TAG_NAME"
          git push origin "$TAG_NAME" -f
          sleep 3

          # 4. Delete old release if exists
          tea release delete --repo "$REPO" --confirm "$TAG_NAME" 2>/dev/null || true

          # 5. Create new release with APK - CORRECTED FLAG
          tea release create \
            --repo "$REPO" \
            --title "Rolling Development Build" \
            --note "Automated signed build\nCommit: ${{ github.sha }}" \
            --prerelease \
            --asset "$APK_PATH" \
            "$TAG_NAME"

          echo "âœ… Rolling release updated!"
          echo ""
          echo "ðŸ“± APK should now be available at:"
          echo "https://codeberg.org/$REPO/releases/download/$TAG_NAME/$(basename "$APK_PATH")"
