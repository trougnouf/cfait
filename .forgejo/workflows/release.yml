# File: ./.forgejo/workflows/release.yml
name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  # --- JOB 1: LINUX ARTIFACTS (Ubuntu 24.04) ---
  build-linux:
    runs-on: self-hosted-ubuntu
    container:
      image: local/ubuntu-builder
      volumes:
        - cargo-registry:/usr/local/cargo/registry

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build Linux Binaries
        run: cargo build --release --features gui

      - name: Create Debian Package
        run: |
          cargo deb --no-build --features gui
          mkdir -p dist
          mv target/debian/*.deb dist/

      - name: Create Generic Linux Archives
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            RAW_VERSION="${{ github.ref_name }}"
            CLEAN_VERSION=$(echo "$RAW_VERSION" | sed 's/^v//')
          else
            RAW_VERSION="debug-${{ github.sha }}"
            CLEAN_VERSION="$RAW_VERSION"
          fi
          
          # 1. Source Tarball (Needed for AUR hash)
          git archive --format=tar.gz --prefix="cfait-${CLEAN_VERSION}/" -o "dist/cfait-source-${RAW_VERSION}.tar.gz" HEAD
          
          # 2. Linux Binary Tarball
          mkdir "cfait-linux-${CLEAN_VERSION}"
          cp target/release/cfait "cfait-linux-${CLEAN_VERSION}/"
          cp target/release/gui "cfait-linux-${CLEAN_VERSION}/cfait-gui"
          cp README.md LICENSE "cfait-linux-${CLEAN_VERSION}/"
          cp assets/cfait.desktop "cfait-linux-${CLEAN_VERSION}/"
          cp assets/cfait.svg "cfait-linux-${CLEAN_VERSION}/"
          tar -czvf "dist/cfait-linux-${RAW_VERSION}.tar.gz" "cfait-linux-${CLEAN_VERSION}"

      # Pass Linux artifacts to the Arch job
      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: linux-artifacts
          path: dist/*

# --- JOB 3: ANDROID BUILD (Ubuntu) ---
  build-android:
    # This job now depends on build-linux and build-windows-and-publish
    # so it can upload the AAB to the same release.
    needs: build-windows-and-publish
    runs-on: self-hosted-ubuntu
    container:
      image: local/ubuntu-builder # Rebuild this image with the Android SDK
      volumes:
        - cargo-registry:/usr/local/cargo/registry
        - gradle-cache:/root/.gradle

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. Decode Keystore Secret
      - name: Restore Keystore
        if: startsWith(github.ref, 'refs/tags/')
        run: echo "${{ secrets.ANDROID_SIGNING_KEYSTORE_B64 }}" | base64 --decode > cfait-release.keystore

      # 2. Build Rust Libraries (.so)
      - name: Build Rust JNI Libs
        run: |
          cargo ndk \
            -t aarch64-linux-android \
            -t armv7-linux-androideabi \
            -t x86_64-linux-android \
            -o ./android/app/src/main/jniLibs \
            build --release --lib

# 3. Build Signed Android App Bundle (AAB)
      - name: Build Android App Bundle
        if: startsWith(github.ref, 'refs/tags/')
        env:
          # USE ABSOLUTE PATH HERE
          KEYSTORE_FILE: "${{ github.workspace }}/cfait-release.keystore"
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          cd android
          chmod +x gradlew
          ./gradlew bundleRelease --no-daemon

      # 4. Upload AAB to Codeberg Releases
      # This reuses the 'tea' tool from your previous job
      - name: Upload AAB to Codeberg
        if: startsWith(github.ref, 'refs/tags/')
        env:
          TEA_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          # Find the generated AAB file and rename it
          AAB_FILE=$(find android/app/build/outputs/bundle/release -name '*.aab' -print -quit)
          if [ -z "$AAB_FILE" ]; then
            echo "Error: AAB file not found!"
            exit 1
          fi
          
          RAW_VERSION="${{ github.ref_name }}"
          mv "$AAB_FILE" "cfait-android-${RAW_VERSION}.aab"

          # Login and upload
          tea login add --name codeberg --url ${{ github.server_url }} --token ${{ secrets.RELEASE_TOKEN }}
          tea release assets create --repo ${{ github.repository }} ${{ github.ref_name }} "cfait-android-${RAW_VERSION}.aab"

  # --- JOB 2: WINDOWS BUILD & PUBLISH (Arch) ---
  build-windows-and-publish:
    needs: build-linux
    runs-on: self-hosted-arch
    container:
      image: local/arch-builder
      volumes:
        - cargo-registry:/usr/local/cargo/registry

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. Download artifacts from Ubuntu job
      - name: Download Linux Artifacts
        uses: actions/download-artifact@v3
        with:
          name: linux-artifacts
          path: dist

      # 2. Compile Windows (On Arch)
      - name: Build Windows Binaries
        run: |
          # Ensure target is installed (Dockerfile should have it, but safe to check)
          rustup target add x86_64-pc-windows-gnu
          cargo build --release --target x86_64-pc-windows-gnu --features gui

      # 3. Package Windows
      - name: Create Windows Archive
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            RAW_VERSION="${{ github.ref_name }}"
          else
            RAW_VERSION="debug-${{ github.sha }}"
          fi
          
          mkdir -p windows-staging
          cp target/x86_64-pc-windows-gnu/release/cfait.exe windows-staging/
          cp target/x86_64-pc-windows-gnu/release/gui.exe windows-staging/cfait-gui.exe
          cp README.md LICENSE windows-staging/
          
          # Zip into the dist folder we created during download
          (cd windows-staging && zip -r "../dist/cfait-windows-$RAW_VERSION.zip" .)

      # 4. Generate Changelog
      - name: Generate Changelog
        run: |
          git-cliff --config cliff.toml --verbose --latest --strip header --output dist/CHANGELOG_RELEASE.md

      # 5. Handle AUR (Requires makepkg from Arch)
    
      # 5. Handle AUR (Requires makepkg from Arch)
      - name: Prepare AUR Files
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          RAW_VERSION="${{ github.ref_name }}"
          CLEAN_VER=$(echo "$RAW_VERSION" | sed 's/^v//')
          
          cd dist
          
          # Calculate Hash
          if [ ! -f "cfait-source-${RAW_VERSION}.tar.gz" ]; then
            echo "Error: Source tarball not found"
            exit 1
          fi
          
          HASH=$(sha256sum "cfait-source-${RAW_VERSION}.tar.gz" | awk '{print $1}')
          
          # Copy PKGBUILD
          cp ../packaging/arch/PKGBUILD .
          
          # Update Version, Hash, Source
          sed -i "s/pkgver=.*/pkgver=${CLEAN_VER}/" PKGBUILD
          sed -i "s/'SKIP'/'$HASH'/" PKGBUILD
          NEW_SOURCE_URL="https://codeberg.org/trougnouf/cfait/releases/download/${RAW_VERSION}/cfait-source-${RAW_VERSION}.tar.gz"
          sed -i "s|source=.*|source=(\"cfait-source-${RAW_VERSION}.tar.gz::${NEW_SOURCE_URL}\")|" PKGBUILD
          
          # --- FIX IS HERE ---
          # Give 'builder' ownership of the directory so it can write .SRCINFO
          chown -R builder:builder .
          
          # Generate .SRCINFO as builder
          su builder -c "makepkg --printsrcinfo > .SRCINFO"

  

      # 6. Upload Everything
      - name: Upload to Codeberg Releases
        if: startsWith(github.ref, 'refs/tags/')
        env:
          TEA_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          tea login add --name codeberg --url ${{ github.server_url }} --token ${{ secrets.RELEASE_TOKEN }}
          tea release delete --repo ${{ github.repository }} --confirm ${{ github.ref_name }} || true
          
          tea release create \
            --repo "${{ github.repository }}" \
            --title "${{ github.ref_name }}" \
            --tag "${{ github.ref_name }}" \
            --note-file dist/CHANGELOG_RELEASE.md

          echo "Uploading assets..."
          cd dist
          for file in *; do
            if [ "$file" != "CHANGELOG_RELEASE.md" ] && [ "$file" != "PKGBUILD" ] && [ "$file" != ".SRCINFO" ]; then
              tea release assets create --repo ${{ github.repository }} ${{ github.ref_name }} "$file"
            fi
          done
          
          # Upload PKGBUILD separately
          tea release assets create --repo ${{ github.repository }} ${{ github.ref_name }} PKGBUILD

      # 7. Push to AUR
      - name: Push to AUR
        if: startsWith(github.ref, 'refs/tags/')
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
        run: |
          mkdir -p /root/.ssh
          echo "$AUR_SSH_KEY" > /root/.ssh/aur_key
          chmod 600 /root/.ssh/aur_key
          ssh-keyscan aur.archlinux.org >> /root/.ssh/known_hosts
          export GIT_SSH_COMMAND="ssh -i /root/.ssh/aur_key -o UserKnownHostsFile=/root/.ssh/known_hosts"
          
          git config --global user.name "Cfait Bot (Benoit Brummer)"
          git config --global user.email "trougnouf@gmail.com"
          
          git clone ssh://aur@aur.archlinux.org/cfait.git aur-repo
          
          cp dist/PKGBUILD aur-repo/
          cp dist/.SRCINFO aur-repo/
          
          cd aur-repo
          git add PKGBUILD .SRCINFO
          
          if git diff --staged --quiet; then
            echo "No changes to AUR files."
          else
            git commit -m "Update to ${{ github.ref_name }}"
            git push
            echo "ðŸš€ Successfully pushed to AUR!"
          fi